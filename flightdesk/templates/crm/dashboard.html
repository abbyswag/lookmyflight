{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}

{% if is_supervisor %}
<div class="bg-white p-6 rounded-lg shadow-lg mb-6 col-span-1 md:col-span-3 mt-6">
    <div class="flex justify-between mb-4">
        <h3 class="text-2xl font-semibold text-gray-800">Call Log Summary</h3>
        <a href="{% url 'download_call_log_excel' %}?filter={{ dateFilter.value }}&start_date={{ startDate }}&end_date={{ endDate }}" 
        class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700">
            Download Excel
        </a>
    </div>

    <!-- Date Filter -->
    <div class="mb-6">
        <label for="dateFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Date:</label>
        <select id="dateFilter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            <option value="today">Today</option>
            <option value="lastWeek">Last Week</option>
            <option value="lastMonth">Last Month</option>
            <option value="custom">Custom Date Range</option>
        </select>
        <div id="customDateRange" class="mt-3 hidden">
            <input type="date" id="startDate" class="mr-2 py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            <input type="date" id="endDate" class="py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
        </div>
    </div>

    <canvas id="callLogBarChart"></canvas>

    <div id="tableContainer" class="lg:w-full overflow-x-auto">
        <!-- Table content will be dynamically updated here -->
    </div>
</div>
{% endif %}

{% if is_supervisor %}
<div class="bg-white p-6 rounded-lg shadow-lg mb-6 col-span-1 md:col-span-3">
    <div class="flex justify-between align-center mb-4">
        <h3 class="text-2xl font-semibold text-gray-800">Booking Summary</h3>
        <a href="{% url 'download_bookings_excel' %}?filter={{ dateFilter.value }}&start_date={{ startDate }}&end_date={{ endDate }}" 
        class="bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700">
            Download Excel
        </a>
    </div>
     
    <!-- Filters -->
    <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Date Filter -->
        <div>
            <label for="bookingDateFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Date:</label>
            <select id="bookingDateFilter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="today">Today</option>
                <option value="lastWeek">Last Week</option>
                <option value="lastMonth">Last Month</option>
                <option value="custom">Custom Date Range</option>
            </select>
            <div id="bookingCustomDateRange" class="mt-3 hidden">
                <input type="date" id="bookingStartDate" class="mr-2 py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <input type="date" id="bookingEndDate" class="py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
        </div>

        <!-- Tag Filter -->
        <div>
            <label for="bookingTagFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Tag:</label>
            <select id="bookingTagFilter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="">All Tags</option>
                {% for tag in tags %}
                    <option value="{{ tag.code }}">{{ tag.code }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- Query Type Filter -->
        <div>
            <label for="bookingQueryTypeFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Query Type:</label>
            <select id="bookingQueryTypeFilter" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                <option value="">All Query Types</option>
                {% for query_type in query_types %}
                    <option value="{{ query_type.code }}">{{ query_type.code }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Line Chart Container -->
    <div>
        <canvas id="bookingLineChart" width="400" height="200"></canvas>
    </div>
    <!-- Booking Summary Table -->
    <div id="bookingSummaryTableContainer" class="overflow-x-auto">
        <!-- Table content will be dynamically updated here -->
    </div>
</div>
{% endif %}


<div class="container">
    <h1>Customer Heatmap</h1>
    
    <!-- Heatmap Section -->
    <div id="heatmap"></div>

    <!-- Top 5 Locations Table -->
    <div class="top-locations">
        <h2>Top 5 Locations</h2>
        <table>
            <thead>
                <tr>
                    <th>Zipcode</th>
                    <th>Total Revenue</th>
                    <th>Total Bookings</th>
                    <th>Total Passengers</th>
                </tr>
            </thead>
            <tbody id="topLocationsTable">
                <!-- Data will be dynamically populated -->
            </tbody>
        </table>
    </div>
</div>


{% endblock %}
{% block scripts %}
{{ block.super }}

<!-- Call Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const dateFilter = document.getElementById('dateFilter');
    const customDateRange = document.getElementById('customDateRange');

    dateFilter.addEventListener('change', function() {
        if (this.value === 'custom') {
            customDateRange.classList.remove('hidden');
        } else {
            customDateRange.classList.add('hidden');
        }
        fetchCallLogSummary();
    });

    function fetchCallLogSummary() {
        const filterValue = dateFilter.value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        fetch(`/api/call-log-summary/?filter=${filterValue}&start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                updateCallLogSummaryTable(data);
            });
    }

    function updateCallLogSummaryTable(data) {
        const tableContainer = document.getElementById('tableContainer');
        const callLogCounts = data.call_log_counts;
        const tags = data.tags;
        const queryTypes = data.query_types;

        // Create table headers
        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tag</th>
                        ${queryTypes.map(qt => `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${qt}</th>`).join('')}
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

        // Create table rows
        tags.forEach(tag => {
            const tagCounts = callLogCounts[tag] || {};
            tableHTML += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${tag}</td>
                    ${queryTypes.map(qt => `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tagCounts[qt] || 0}</td>`).join('')}
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${tagCounts['total'] || 0}</td>
                </tr>
            `;
        });

        tableHTML += `
                </tbody>
            </table>
        `;

        // Update the table container
        tableContainer.innerHTML = tableHTML;
    }

        // Initial data load
        fetchCallLogSummary();
    });

    function fetchCallLogBarChartData() {
    const filterValue = dateFilter.value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    fetch(`/api/call-log-bar-chart/?filter=${filterValue}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            const tagLabels = data.tags.map(item => item.tag__code || 'Unknown');
            const tagCounts = data.tags.map(item => item.count);

            const queryTypeLabels = data.query_types.map(item => item.query_type__code || 'Unknown');
            const queryTypeCounts = data.query_types.map(item => item.count);

            // Update Bar Chart Data
            callLogBarChart.data.labels = [...tagLabels, ...queryTypeLabels];
            callLogBarChart.data.datasets[0].data = [...tagCounts, ...Array(queryTypeLabels.length).fill(0)];
            callLogBarChart.data.datasets[1].data = [...Array(tagLabels.length).fill(0), ...queryTypeCounts];
            callLogBarChart.update();
        });
}

// Initialize Chart.js Bar Chart
const callLogCtx = document.getElementById('callLogBarChart').getContext('2d');
const callLogBarChart = new Chart(callLogCtx, {
    type: 'bar',
    data: {
        labels: [], // Tags and Query Types
        datasets: [
            { label: 'By Tag', data: [], backgroundColor: '#36A2EB' },
            { label: 'By Query Type', data: [], backgroundColor: '#FFCE56' },
        ]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'top',
            },
            title: {
                display: true,
                text: 'Call Log Distribution'
            }
        },
        scales: {
            x: { title: { display: true, text: 'Tags and Query Types' } },
            y: { title: { display: true, text: 'Count' }, beginAtZero: true }
        }
    }
});

// Fetch data when filters change
dateFilter.addEventListener('change', fetchCallLogBarChartData);
fetchCallLogBarChartData(); // Initial load


</script>

<!-- Booking Scripts -->
<script>
    // Booking Summary functionality
    const bookingDateFilter = document.getElementById('bookingDateFilter');
    const bookingCustomDateRange = document.getElementById('bookingCustomDateRange');
    const bookingTagFilter = document.getElementById('bookingTagFilter');
    const bookingQueryTypeFilter = document.getElementById('bookingQueryTypeFilter');

    bookingDateFilter.addEventListener('change', function() {
        if (this.value === 'custom') {
            bookingCustomDateRange.classList.remove('hidden');
        } else {
            bookingCustomDateRange.classList.add('hidden');
        }
        updateBookingSummary();
    });

    bookingTagFilter.addEventListener('change', updateBookingSummary);
    bookingQueryTypeFilter.addEventListener('change', updateBookingSummary);

    function updateBookingSummary() {
        const filterValue = bookingDateFilter.value;
        const startDate = document.getElementById('bookingStartDate').value;
        const endDate = document.getElementById('bookingEndDate').value;
        const tag = bookingTagFilter.value;
        const queryType = bookingQueryTypeFilter.value;

        fetch(`/api/booking-summary/?filter=${filterValue}&start_date=${startDate}&end_date=${endDate}&tag=${tag}&query_type=${queryType}`)
            .then(response => response.json())
            .then(data => {
                updateBookingSummaryTable(data);
            });
    }

    function updateBookingSummaryTable(data) {
        const tableContainer = document.getElementById('bookingSummaryTableContainer');
        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. of Bookings</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. of Passengers</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Revenue (MCO)</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    ${data.map(row => `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.agent}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.num_bookings}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.num_passengers}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.revenue}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
        tableContainer.innerHTML = tableHTML;
    }

    // Initial load of booking summary
    updateBookingSummary();

    function fetchDailyChartData() {
    const filterValue = bookingDateFilter.value;
    const startDate = document.getElementById('bookingStartDate').value;
    const endDate = document.getElementById('bookingEndDate').value;

    fetch(`/api/booking-daily-chart/?filter=${filterValue}&start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            bookingLineChart.data.labels = data.dates;
            bookingLineChart.data.datasets[0].data = data.daily_bookings;
            bookingLineChart.data.datasets[1].data = data.daily_passengers;
            bookingLineChart.data.datasets[2].data = data.daily_revenue;
            bookingLineChart.update();
        });
}

// Initialize Chart.js Line Chart
const bookingLineCtx = document.getElementById('bookingLineChart').getContext('2d');
const bookingLineChart = new Chart(bookingLineCtx, {
    type: 'line',
    data: {
        labels: [], // Dates
        datasets: [
            { label: 'Bookings', data: [], borderColor: '#FF6384', tension: 0.4 },
            { label: 'Passengers', data: [], borderColor: '#36A2EB', tension: 0.4 },
            { label: 'Revenue', data: [], borderColor: '#FFCE56', tension: 0.4 },
        ]
    },
    options: {
        responsive: true,
        scales: {
            x: { title: { display: true, text: 'Dates' } },
            y: { title: { display: true, text: 'Counts/Amount' }, beginAtZero: true }
        }
    }
});

// Fetch data when filters change
bookingDateFilter.addEventListener('change', fetchDailyChartData);
bookingTagFilter.addEventListener('change', fetchDailyChartData);
bookingQueryTypeFilter.addEventListener('change', fetchDailyChartData);
fetchDailyChartData(); // Initial load

</script>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Initialize the map
    const map = L.map('heatmap').setView([20, 78], 5); // Centered on India with a zoom level of 5

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap contributors',
    }).addTo(map);

    // Fetch heatmap and top locations data
    axios.get('/api/customer-heatmap/')
        .then(response => {
            const { heatmap_data, top_locations } = response.data;

            // Prepare heatmap layer data
            const heatmapPoints = heatmap_data.map(item => {
                // You need to have pre-fetched lat/lng for zipcodes
                return [item.latitude, item.longitude, item.total_revenue];
            });

            // Add heatmap layer to the map
            L.heatLayer(heatmapPoints, { radius: 25 }).addTo(map);

            // Populate the Top 5 Locations Table
            const topLocationsTable = document.getElementById('topLocationsTable');
            let tableHTML = '';

            top_locations.forEach(location => {
                tableHTML += `
                    <tr>
                        <td>${location.zipcode}</td>
                        <td>${location.total_revenue.toFixed(2)}</td>
                        <td>${location.total_bookings}</td>
                        <td>${location.total_passengers}</td>
                    </tr>
                `;
            });

            topLocationsTable.innerHTML = tableHTML;
        })
        .catch(error => {
            console.error('Error fetching heatmap data:', error);
        });
});
</script>

{% endblock %}
